- name: disable nginx
  ansible.builtin.shell: dnf module disable nginx -y

- name: enable nginx
  ansible.builtin.shell: dnf module enable nginx:1.24 -y

- name: Install nginx
  ansible.builtin.dnf:
    name: nginx
    state: installed

- name: Read backend service URLs from Vault
  ansible.builtin.set_fact:
    catalogue_url: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=roboshop-' ~ env ~ '/data/frontend:CATALOGUE_URL token=' ~ token ~ ' url=http://vault-internal.sdevops.shop:8200') }}"
    user_url: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=roboshop-' ~ env ~ '/data/frontend:USER_URL token=' ~ token ~ ' url=http://vault-internal.sdevops.shop:8200') }}"
    cart_url: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=roboshop-' ~ env ~ '/data/frontend:CART_URL token=' ~ token ~ ' url=http://vault-internal.sdevops.shop:8200') }}"
    shipping_url: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=roboshop-' ~ env ~ '/data/frontend:SHIPPING_URL token=' ~ token ~ ' url=http://vault-internal.sdevops.shop:8200') }}"
    payment_url: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=roboshop-' ~ env ~ '/data/frontend:PAYMENT_URL token=' ~ token ~ ' url=http://vault-internal.sdevops.shop:8200') }}"

- name: copy the nginx conf file
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    mode: "0644"

- name: delete old nginx html file
  ansible.builtin.file:
    path: /usr/share/nginx/html/
    state: absent

- name: create dest file for config
  ansible.builtin.file:
    path: /usr/share/nginx/html
    state: directory

- name: Unarchive a file
  ansible.builtin.unarchive:
    src: https://roboshop-artifacts.s3.amazonaws.com/frontend-v3.zip
    dest: /usr/share/nginx/html/
    remote_src: yes

- name: Restart nginx
  ansible.builtin.systemd_service:
    name: nginx
    state: restarted
    enabled: true
    daemon_reload: true
